@inherits LayoutComponentBase
@using BlazingFastPublishQueue.Server.Models
@using System.Text.RegularExpressions;

<MudGrid>
    <MudItem xs="12" sm="6" md="4">
        <MudSelect T="string" @bind-Value="Filter.PublishTarget" Label="Publish Target" OffsetY="true" Variant="Variant.Outlined" SelectedValuesChanged="OnChange">
            <MudSelectItem Value="@("None")" />
            @foreach (var option in PublishTargets)
            {
                <MudSelectItem Value="@option" />
            }
        </MudSelect>
    </MudItem>

    <MudItem xs="12" sm="6" md="4">
        <MudSelect T="PublishState?" @bind-Value="Filter.State" Label="State" ToStringFunc="@publishStateConverter" OffsetY="true" Variant="Variant.Outlined" SelectedValuesChanged="OnChange">
            @foreach (PublishState? option in Enum.GetValues(typeof(PublishState)))
            {
                <MudSelectItem Value="@option" />
            }
        </MudSelect>
    </MudItem>

    <MudItem xs="12" sm="6" md="4">
        <MudSelect T="ItemType?" @bind-Value="Filter.ItemType" Label="Item Type" OffsetY="true" Variant="Variant.Outlined" SelectedValuesChanged="OnChange">
            @foreach (ItemType? option in Enum.GetValues(typeof(ItemType)))
            {
                if (option.Equals(ItemType.None))
                {
                    <MudSelectItem Value="@option" />
                }
                else
                {
                    <MudSelectItem Value="@option">
                        <img src="/images/@(option?.ToString().ToLower()).png" height="16" class="mr-1" /> @option
                    </MudSelectItem>
                }
            }
        </MudSelect>
    </MudItem>

    <MudItem xs="12" sm="6" md="4">
        <MudAutocomplete T="string" Label="User" @bind-Value="Filter.User" SearchFunc="@UserSearch" ResetValueOnEmptyText="true" Variant="Variant.Outlined" TextChanged="OnChange" />
    </MudItem>

    <MudItem xs="12" sm="6" md="4">
        <MudSelect T="string" @bind-Value="Filter.Publication" Label="Publication" OffsetY="true" Variant="Variant.Outlined" SelectedValuesChanged="OnChange">
            <MudSelectItem Value="@("None")" />
            @foreach (var option in Publications)
            {
                <MudSelectItem Value="@option" />
            }
        </MudSelect>
    </MudItem>

    <MudItem xs="12" sm="6" md="4">
        <MudSelect T="string" @bind-Value="Filter.Server" Label="Server" OffsetY="true" Variant="Variant.Outlined" SelectedValuesChanged="OnChange">
            <MudSelectItem Value="@("None")" />
            @foreach (var option in Servers)
            {
                <MudSelectItem Value="@option" />
            }
        </MudSelect>
    </MudItem>

    <MudItem xs="12" sm="6" md="4">
        <MudSelect T="string" @bind-Value="published" Label="Publish action" OffsetY="true" Variant="Variant.Outlined" SelectedValuesChanged="OnChange">
            <MudSelectItem Value="@("None")" />
            <MudSelectItem Value="@("Published")" />
            <MudSelectItem Value="@("Unpublished")" />
        </MudSelect>
    </MudItem>

    <MudItem xs="12" sm="6" md="4">
        <MudDateRangePicker @bind-DateRange="Filter.DateRange" Label="Date range" Editable="true" DisableToolbar="true" InputVariant="Variant.Outlined" PickerClosed="OnChange" />
    </MudItem>

    <MudItem xs="12">
        <MudTextField @bind-Value="Filter.Query" Label="Search" Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentIcon="@Icons.Filled.Search" AdornmentColor="Color.Secondary" TextChanged="OnChange" />
    </MudItem>
</MudGrid>

@code {
    [Parameter]
    public Filter Filter { get; set; }

    [Parameter]
    public EventCallback OnFilterChanged { get; set; }

    [Parameter]
    public IEnumerable<string> PublishTargets { get; set; }

    [Parameter]
    public IEnumerable<string> Publications { get; set; }

    [Parameter]
    public IEnumerable<string> Servers { get; set; }

    [Parameter]
    public Func<string, Task<IEnumerable<string>>> UserSearch { get; set; }

    private Func<PublishState?, string> publishStateConverter = s => Regex.Replace(s?.ToString() ?? "", @"\B[A-Z]", m => $" {m?.Value.ToLower()}");


    private string? published
    {
        get => Filter.Published is null ? null : (Filter.Published ?? false ? "Published" : "Unpublished");
        set
        {
            Filter.Published = value switch
            {
                "Published" => true,
                "Unpublished" => false,
                _ => null
            };
        }
    }

    private async Task OnChange()
    {
        await OnFilterChanged.InvokeAsync();
    }
}
